!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("diff_match_patch")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","diff_match_patch"],e):e(CodeMirror,diff_match_patch)}(function(v,e){"use strict";var b=v.Pos,k="http://www.w3.org/2000/svg";function C(e,t){this.mv=e,this.type=t,this.classes="left"==t?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}function s(e){e.diffOutOfDate&&(e.diff=p(e.orig.getValue(),e.edit.getValue()),e.chunks=I(e.diff),e.diffOutOfDate=!1,v.signal(e.edit,"updateDiff",e.diff))}var T=!(C.prototype={constructor:C,init:function(e,t,r){var i;this.edit=this.mv.edit,this.orig=v(e,R({value:t,readOnly:!this.mv.options.allowEditingOriginals},R(r))),this.diff=p(u(t),u(r.value)),this.chunks=I(this.diff),this.diffOutOfDate=this.dealigned=!1,this.showDifferences=!1!==r.showDifferences,this.forceUpdate=function(r){var t,i={from:0,to:0,marked:[]},o={from:0,to:0,marked:[]},n=!1;function l(e){n=!(T=!0),"full"==e&&(r.svg&&x(r.svg),r.copyButtons&&x(r.copyButtons),f(r.edit,i.marked,r.classes),f(r.orig,o.marked,r.classes),i.from=i.to=o.from=o.to=0),s(r),r.showDifferences&&(h(r.edit,r.diff,i,DIFF_INSERT,r.classes),h(r.orig,r.diff,o,DIFF_DELETE,r.classes)),y(r),"align"==r.mv.options.connect&&M(r),T=!1}function a(e){T||(r.dealigned=!0,c(e))}function c(e){T||n||(clearTimeout(t),!0===e&&(n=!0),t=setTimeout(l,!0===e?20:250))}function e(e,t){r.diffOutOfDate||(r.diffOutOfDate=!0,i.from=i.to=o.from=o.to=0),a(t.text.length-1!=t.to.line-t.from.line)}return r.edit.on("change",e),r.orig.on("change",e),r.edit.on("markerAdded",a),r.edit.on("markerCleared",a),r.orig.on("markerAdded",a),r.orig.on("markerCleared",a),r.edit.on("viewportChange",function(){c(!1)}),r.orig.on("viewportChange",function(){c(!1)}),l(),l}(this),n(this,!0,!1),(i=this).edit.on("scroll",function(){o(i,DIFF_INSERT)&&y(i)}),i.orig.on("scroll",function(){o(i,DIFF_DELETE)&&y(i)})},setShowDifferences:function(e){(e=!1!==e)!=this.showDifferences&&(this.showDifferences=e,this.forceUpdate("full"))}});function o(e,t){if(e.diffOutOfDate)return!1;if(!e.lockScroll)return!0;var r,i,o=+new Date;if(t==DIFF_INSERT?(r=e.edit,i=e.orig):(r=e.orig,i=e.edit),r.state.scrollSetBy==e&&(r.state.scrollSetAt||0)+50>o)return!1;var n=r.getScrollInfo();if("align"==e.mv.options.connect)m=n.top;else{var l,a,c=.5*n.clientHeight,s=n.top+c,f=r.lineAtHeight(s,"local"),h=function(e,t,r){for(var i,o,n,l,a=0;a<e.length;a++){var c=e[a],s=r?c.editFrom:c.origFrom,f=r?c.editTo:c.origTo;null==o&&(t<s?(o=c.editFrom,l=c.origFrom):t<f&&(o=c.editTo,l=c.origTo)),f<=t?(i=c.editTo,n=c.origTo):s<=t&&(i=c.editFrom,n=c.origFrom)}return{edit:{before:i,after:o},orig:{before:n,after:l}}}(e.chunks,f,t==DIFF_INSERT),d=F(r,t==DIFF_INSERT?h.edit:h.orig),g=F(i,t==DIFF_INSERT?h.orig:h.edit),u=(s-d.top)/(d.bot-d.top),m=g.top-c+u*(g.bot-g.top);if(m>n.top&&(a=n.top/c)<1)m=m*a+n.top*(1-a);else if((l=n.height-n.clientHeight-n.top)<c){var p=i.getScrollInfo();l<p.height-p.clientHeight-m&&(a=l/c)<1&&(m=m*a+(p.height-p.clientHeight-l)*(1-a))}}return i.scrollTo(n.left,m),i.state.scrollSetAt=o,i.state.scrollSetBy=e,!0}function F(e,t){var r=t.after;return null==r&&(r=e.lastLine()+1),{top:e.heightAtLine(t.before||0,"local"),bot:e.heightAtLine(r,"local")}}function n(e,t,r){(e.lockScroll=t)&&0!=r&&o(e,DIFF_INSERT)&&y(e),e.lockButton.innerHTML=t?"⇛⇚":"⇛&nbsp;&nbsp;⇚"}function f(e,t,r){for(var i=0;i<t.length;++i){var o=t[i];o instanceof v.TextMarker?o.clear():o.parent&&(e.removeLineClass(o,"background",r.chunk),e.removeLineClass(o,"background",r.start),e.removeLineClass(o,"background",r.end))}t.length=0}function h(e,t,r,i,o){var n=e.getViewport();e.operation(function(){r.from==r.to||20<n.from-r.to||20<r.from-n.to?(f(e,r.marked,o),l(e,t,i,r.marked,n.from,n.to,o),r.from=n.from,r.to=n.to):(n.from<r.from&&(l(e,t,i,r.marked,n.from,r.from,o),r.from=n.from),n.to>r.to&&(l(e,t,i,r.marked,r.to,n.to,o),r.to=n.to))})}function l(l,e,t,a,c,s,f){var r=b(0,0),i=b(c,0),o=l.clipPos(b(s-1)),n=t==DIFF_DELETE?f.del:f.insert;function h(e,t){for(var r=Math.max(c,e),i=Math.min(s,t),o=r;o<i;++o){var n=l.addLineClass(o,"background",f.chunk);o==e&&l.addLineClass(n,"background",f.start),o==t-1&&l.addLineClass(n,"background",f.end),a.push(n)}e==t&&r==t&&i==t&&(r?a.push(l.addLineClass(r-1,"background",f.end)):a.push(l.addLineClass(r,"background",f.start)))}for(var d,g,u,m,p,v,k=0,C=0;C<e.length;++C){var T=e[C],F=T[0],y=T[1];if(F==DIFF_EQUAL){var w=r.line+(S(e,C)?0:1);V(r,y);var M=r.line+(E(e,C)?1:0);w<M&&(C&&h(k,w),k=M)}else if(F==t){var D=V(r,y,!0),L=(v=r,0<((p=i).line-v.line||p.ch-v.ch)?p:v),I=(m=D,((u=o).line-m.line||u.ch-m.ch)<0?u:m);g=I,((d=L).line!=g.line||d.ch!=g.ch)&&a.push(l.markText(L,I,{className:n})),r=D}}k<=r.line&&h(k,r.line+1)}function y(e){if(e.showDifferences){if(e.svg){x(e.svg);var t=e.gap.offsetWidth;B(e.svg,"width",t,"height",e.gap.offsetHeight)}e.copyButtons&&x(e.copyButtons);for(var r=e.edit.getViewport(),i=e.orig.getViewport(),o=e.edit.getScrollInfo().top,n=e.orig.getScrollInfo().top,l=0;l<e.chunks.length;l++){var a=e.chunks[l];a.editFrom<=r.to&&a.editTo>=r.from&&a.origFrom<=i.to&&a.origTo>=i.from&&g(e,a,n,o,t)}}}function w(e,t){for(var r=0,i=0,o=0;o<t.length;o++){var n=t[o];if(n.editTo>e&&n.editFrom<=e)return null;if(n.editFrom>e)break;r=n.editTo,i=n.origTo}return i+(e-r)}function M(e,t){if(e.dealigned||t){if(!e.orig.curOp)return e.orig.operation(function(){M(e,t)});e.dealigned=!1;var r=e.mv.left==e?e.mv.right:e.mv.left;r&&(s(r),r.dealigned=!1);for(var i=function(e,t){for(var r=[],i=0;i<e.chunks.length;i++){var o=e.chunks[i];r.push([o.origTo,o.editTo,t?w(o.editTo,t.chunks):null])}if(t)for(i=0;i<t.chunks.length;i++){o=t.chunks[i];for(var n=0;n<r.length;n++){var l=r[n];if(l[1]==o.editTo){n=-1;break}if(l[1]>o.editTo)break}-1<n&&r.splice(n-1,0,[w(o.editTo,e.chunks),o.editTo,o.origTo])}return r}(e,r),o=e.mv.aligners,n=0;n<o.length;n++)o[n].clear();o.length=0;var l=[e.orig,e.edit],a=[];r&&l.push(r.orig);for(n=0;n<l.length;n++)a.push(l[n].getScrollInfo().top);for(var c=0;c<i.length;c++)d(l,i[c],o);for(n=0;n<l.length;n++)l[n].scrollTo(null,a[n])}}function d(e,t,r){for(var i=0,o=[],n=0;n<e.length;n++)if(null!=t[n]){var l=e[n].heightAtLine(t[n],"local");o[n]=l,i=Math.max(i,l)}for(n=0;n<e.length;n++)if(null!=t[n]){var a=i-o[n];1<a&&r.push(c(e[n],t[n],a))}}function c(e,t,r){var i=!0;t>e.lastLine()&&(t--,i=!1);var o=document.createElement("div");return o.className="CodeMirror-merge-spacer",o.style.height=r+"px",o.style.minWidth="1px",e.addLineWidget(t,o,{height:r,above:i})}function g(e,t,r,i,o){var n="left"==e.type,l=e.orig.heightAtLine(t.origFrom,"local")-r;if(e.svg){var a=l,c=e.edit.heightAtLine(t.editFrom,"local")-i;if(n){var s=a;a=c,c=s}var f=e.orig.heightAtLine(t.origTo,"local")-r,h=e.edit.heightAtLine(t.editTo,"local")-i;if(n){s=f;f=h,h=s}var d=" C "+o/2+" "+c+" "+o/2+" "+a+" "+(o+2)+" "+a,g=" C "+o/2+" "+f+" "+o/2+" "+h+" -1 "+h;B(e.svg.appendChild(document.createElementNS(k,"path")),"d","M -1 "+c+d+" L "+(o+2)+" "+f+g+" z","class",e.classes.connect)}if(e.copyButtons){var u=e.copyButtons.appendChild(A("div","left"==e.type?"⇝":"⇜","CodeMirror-merge-copy")),m=e.mv.options.allowEditingOriginals;if(u.title=m?"Push to left":"Revert chunk",u.chunk=t,u.style.top=l+"px",m){var p=e.orig.heightAtLine(t.editFrom,"local")-i,v=e.copyButtons.appendChild(A("div","right"==e.type?"⇝":"⇜","CodeMirror-merge-copy-reverse"));v.title="Push to right",v.chunk={editFrom:t.origFrom,editTo:t.origTo,origFrom:t.editFrom,origTo:t.editTo},v.style.top=p+"px","right"==e.type?v.style.left="2px":v.style.right="2px"}}}function a(e,t,r,i){e.diffOutOfDate||t.replaceRange(r.getRange(b(i.origFrom,0),b(i.origTo,0)),b(i.editFrom,0),b(i.editTo,0))}var D=v.MergeView=function(e,t){if(!(this instanceof D))return new D(e,t);var r=(this.options=t).origLeft,i=null==t.origRight?t.orig:t.origRight,o=null!=r,n=null!=i,l=1+(o?1:0)+(n?1:0),a=[],c=this.left=null,s=this.right=null,f=this;if(o){c=this.left=new C(this,"left");var h=A("div",null,"CodeMirror-merge-pane");a.push(h),a.push(L(c))}var d=A("div",null,"CodeMirror-merge-pane");if(a.push(d),n){s=this.right=new C(this,"right"),a.push(L(s));var g=A("div",null,"CodeMirror-merge-pane");a.push(g)}(n?g:d).className+=" CodeMirror-merge-pane-rightmost",a.push(A("div",null,null,"height: 0; clear: both;"));var u=this.wrap=e.appendChild(A("div",a,"CodeMirror-merge CodeMirror-merge-"+l+"pane"));this.edit=v(d,R(t)),c&&c.init(h,r,t),s&&s.init(g,i,t),t.collapseIdentical&&(T=!0,this.editor().operation(function(){!function(e,t){"number"!=typeof t&&(t=2);for(var r=[],i=e.editor(),o=i.firstLine(),n=o,l=i.lastLine();n<=l;n++)r.push(!0);e.left&&_(e.left,t,o,r);e.right&&_(e.right,t,o,r);for(var a=0;a<r.length;a++)if(r[a]){for(var c=a+o,s=1;a<r.length-1&&r[a+1];a++,s++);if(t<s){var f=[{line:c,cm:i}];e.left&&f.push({line:w(c,e.left.chunks),cm:e.left.orig}),e.right&&f.push({line:w(c,e.right.chunks),cm:e.right.orig});var h=N(s,f);e.options.onCollapse&&e.options.onCollapse(e,c,s,h)}}}(f,t.collapseIdentical)}),T=!1),"align"==t.connect&&(this.aligners=[],M(this.left||this.right,!0));var m=function(){c&&y(c),s&&y(s)};v.on(window,"resize",m);var p=setInterval(function(){for(var e=u.parentNode;e&&e!=document.body;e=e.parentNode);e||(clearInterval(p),v.off(window,"resize",m))},5e3)};function L(r){var e=r.lockButton=A("div",null,"CodeMirror-merge-scrolllock");e.title="Toggle locked scrolling";var t=A("div",[e],"CodeMirror-merge-scrolllock-wrap");v.on(e,"click",function(){n(r,!r.lockScroll)});var i=[t];if(!1!==r.mv.options.revertButtons&&(r.copyButtons=A("div",null,"CodeMirror-merge-copybuttons-"+r.type),v.on(r.copyButtons,"click",function(e){var t=e.target||e.srcElement;t.chunk&&("CodeMirror-merge-copy-reverse"!=t.className?a(r,r.edit,r.orig,t.chunk):a(r,r.orig,r.edit,t.chunk))}),i.unshift(r.copyButtons)),"align"!=r.mv.options.connect){var o=document.createElementNS&&document.createElementNS(k,"svg");o&&!o.createSVGRect&&(o=null),(r.svg=o)&&i.push(o)}return r.gap=A("div",i,"CodeMirror-merge-gap")}function u(e){return"string"==typeof e?e:e.getValue()}D.prototype={constuctor:D,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(e){this.right&&this.right.setShowDifferences(e),this.left&&this.left.setShowDifferences(e)},rightChunks:function(){if(this.right)return s(this.right),this.right.chunks},leftChunks:function(){if(this.left)return s(this.left),this.left.chunks}};var m=new e;function p(e,t){var r=m.diff_main(e,t);m.diff_cleanupSemantic(r);for(var i=0;i<r.length;++i){var o=r[i];o[1]?i&&r[i-1][0]==o[0]&&(r.splice(i--,1),r[i][1]+=o[1]):r.splice(i--,1)}return r}function I(e){for(var t=[],r=0,i=0,o=b(0,0),n=b(0,0),l=0;l<e.length;++l){var a=e[l],c=a[0];if(c==DIFF_EQUAL){var s=S(e,l)?0:1,f=o.line+s,h=n.line+s;V(o,a[1],null,n);var d=E(e,l)?1:0,g=o.line+d,u=n.line+d;f<g&&(l&&t.push({origFrom:i,origTo:h,editFrom:r,editTo:f}),r=g,i=u)}else V(c==DIFF_INSERT?o:n,a[1])}return(r<=o.line||i<=n.line)&&t.push({origFrom:i,origTo:n.line+1,editFrom:r,editTo:o.line+1}),t}function E(e,t){if(t==e.length-1)return!0;var r=e[t+1][1];return 1!=r.length&&10==r.charCodeAt(0)&&(t==e.length-2||1<(r=e[t+2][1]).length&&10==r.charCodeAt(0))}function S(e,t){if(0==t)return!0;var r=e[t-1][1];return 10==r.charCodeAt(r.length-1)&&(1==t||10==(r=e[t-2][1]).charCodeAt(r.length-1))}function O(e,t,r){e.addLineClass(t,"wrap","CodeMirror-merge-collapsed-line");var i=document.createElement("span");i.className="CodeMirror-merge-collapsed-widget",i.title="Identical text collapsed. Click to expand.";var o=e.markText(b(t,0),b(r-1),{inclusiveLeft:!0,inclusiveRight:!0,replacedWith:i,clearOnEnter:!0});function n(){o.clear(),e.removeLineClass(t,"wrap","CodeMirror-merge-collapsed-line")}return i.addEventListener("click",n),{mark:o,clear:n}}function N(e,t){var r=[];function i(){for(var e=0;e<r.length;e++)r[e].clear()}for(var o=0;o<t.length;o++){var n=t[o],l=O(n.cm,n.line,n.line+e);r.push(l),l.mark.on("clear",i)}return r[0].mark}function _(e,t,r,i){for(var o=0;o<e.chunks.length;o++)for(var n=e.chunks[o],l=n.editFrom-t;l<n.editTo+t;l++){var a=l+r;0<=a&&a<i.length&&(i[a]=!1)}}function A(e,t,r,i){var o=document.createElement(e);if(r&&(o.className=r),i&&(o.style.cssText=i),"string"==typeof t)o.appendChild(document.createTextNode(t));else if(t)for(var n=0;n<t.length;++n)o.appendChild(t[n]);return o}function x(e){for(var t=e.childNodes.length;0<t;--t)e.removeChild(e.firstChild)}function B(e){for(var t=1;t<arguments.length;t+=2)e.setAttribute(arguments[t],arguments[t+1])}function R(e,t){for(var r in t||(t={}),e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t}function V(e,t,r,i){for(var o=r?b(e.line,e.ch):e,n=0;;){var l=t.indexOf("\n",n);if(-1==l)break;++o.line,i&&++i.line,n=l+1}return o.ch=(n?0:o.ch)+(t.length-n),i&&(i.ch=(n?0:i.ch)+(t.length-n)),o}});