!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],t):t(CodeMirror)}(function(b){"use strict";var x="CodeMirror-hint",k="CodeMirror-hint-active";b.showHint=function(t,e,i){if(!e)return t.showHint(i);i&&i.async&&(e.async=!0);var n={hint:e};if(i)for(var o in i)n[o]=i[o];return t.showHint(n)};var s=0;function p(t,e,i,n){if(t.async){var o=++s;t(e,function(t){s==o&&n(t)},i)}else n(t(e,i))}function n(t,e){this.cm=t,this.options=this.buildOptions(e),this.widget=this.onClose=null}function A(t){return"string"==typeof t?t:t.text}function T(t,e){for(;e&&e!=t;){if("LI"===e.nodeName.toUpperCase()&&e.parentNode==t)return e;e=e.parentNode}}function d(o,t){this.completion=o,this.data=t;var i=this,s=o.cm,c=this.hints=document.createElement("ul");c.className="CodeMirror-hints",this.selectedHint=t.selectedHint||0;for(var e=t.list,n=0;n<e.length;++n){var l=c.appendChild(document.createElement("li")),r=e[n],h=x+(n!=this.selectedHint?"":" "+k);null!=r.className&&(h=r.className+" "+h),l.className=h,r.render?r.render(l,t,r):l.appendChild(document.createTextNode(r.displayText||A(r))),l.hintId=n}var f=s.cursorCoords(o.options.alignWithWord?t.from:null),a=f.left,u=f.bottom,p=!0;c.style.left=a+"px",c.style.top=u+"px";var d=window.innerWidth||Math.max(document.body.offsetWidth,document.documentElement.offsetWidth),m=window.innerHeight||Math.max(document.body.offsetHeight,document.documentElement.offsetHeight);(o.options.container||document.body).appendChild(c);var g=c.getBoundingClientRect();if(0<g.bottom-m){var v=g.bottom-g.top;if(0<f.top-(f.bottom-g.top)-v)c.style.top=(u=f.top-v)+"px",p=!1;else if(m<v){c.style.height=m-5+"px",c.style.top=(u=f.bottom-g.top)+"px";var w=s.getCursor();t.from.ch!=w.ch&&(f=s.cursorCoords(w),c.style.left=(a=f.left)+"px",g=c.getBoundingClientRect())}}var y,C=g.right-d;(0<C&&(g.right-g.left>d&&(c.style.width=d-5+"px",C-=g.right-g.left-d),c.style.left=(a=f.left-C)+"px"),s.addKeyMap(this.keyMap=function(t,n){var o={Up:function(){n.moveFocus(-1)},Down:function(){n.moveFocus(1)},PageUp:function(){n.moveFocus(1-n.menuSize(),!0)},PageDown:function(){n.moveFocus(n.menuSize()-1,!0)},Home:function(){n.setFocus(0)},End:function(){n.setFocus(n.length-1)},Enter:n.pick,Tab:n.pick,Esc:n.close},e=t.options.customKeys,s=e?{}:o;function i(t,e){var i;i="string"!=typeof e?function(t){return e(t,n)}:o.hasOwnProperty(e)?o[e]:e,s[t]=i}if(e)for(var c in e)e.hasOwnProperty(c)&&i(c,e[c]);var l=t.options.extraKeys;if(l)for(var c in l)l.hasOwnProperty(c)&&i(c,l[c]);return s}(o,{moveFocus:function(t,e){i.changeActive(i.selectedHint+t,e)},setFocus:function(t){i.changeActive(t)},menuSize:function(){return i.screenAmount()},length:e.length,close:function(){o.close()},pick:function(){i.pick()},data:t})),o.options.closeOnUnfocus)&&(s.on("blur",this.onBlur=function(){y=setTimeout(function(){o.close()},100)}),s.on("focus",this.onFocus=function(){clearTimeout(y)}));var H=s.getScrollInfo();return s.on("scroll",this.onScroll=function(){var t=s.getScrollInfo(),e=s.getWrapperElement().getBoundingClientRect(),i=u+H.top-t.top,n=i-(window.pageYOffset||(document.documentElement||document.body).scrollTop);if(p||(n+=c.offsetHeight),n<=e.top||n>=e.bottom)return o.close();c.style.top=i+"px",c.style.left=a+H.left-t.left+"px"}),b.on(c,"dblclick",function(t){var e=T(c,t.target||t.srcElement);e&&null!=e.hintId&&(i.changeActive(e.hintId),i.pick())}),b.on(c,"click",function(t){var e=T(c,t.target||t.srcElement);e&&null!=e.hintId&&(i.changeActive(e.hintId),o.options.completeOnSingleClick&&i.pick())}),b.on(c,"mousedown",function(){setTimeout(function(){s.focus()},20)}),b.signal(t,"select",e[0],c.firstChild),!0}b.defineExtension("showHint",function(t){if(!(1<this.listSelections().length||this.somethingSelected())){this.state.completionActive&&this.state.completionActive.close();var e=this.state.completionActive=new n(this,t),i=e.options.hint;if(i)return b.signal(this,"startCompletion",this),p(i,this,e.options,function(t){e.showHints(t)})}}),n.prototype={close:function(){this.active()&&(this.cm.state.completionActive=null,this.widget&&this.widget.close(),this.onClose&&this.onClose(),b.signal(this.cm,"endCompletion",this.cm))},active:function(){return this.cm.state.completionActive==this},pick:function(t,e){var i=t.list[e];i.hint?i.hint(this.cm,t,i):this.cm.replaceRange(A(i),i.from||t.from,i.to||t.to,"complete"),b.signal(t,"pick",i),this.close()},showHints:function(t){if(!t||!t.list.length||!this.active())return this.close();this.options.completeSingle&&1==t.list.length?this.pick(t,0):this.showWidget(t)},showWidget:function(e){this.widget=new d(this,e),b.signal(e,"shown");var i,n=0,o=this,s=this.options.closeCharacters,c=this.cm.getCursor(),l=this.cm.getLine(c.line).length,r=window.requestAnimationFrame||function(t){return setTimeout(t,1e3/60)},h=window.cancelAnimationFrame||clearTimeout;function f(){i||(i=!0,o.close(),o.cm.off("cursorActivity",u),e&&b.signal(e,"close"))}function a(){i||(b.signal(e,"update"),p(o.options.hint,o.cm,o.options,t))}function t(t){if(e=t,!i){if(!e||!e.list.length)return f();o.widget&&o.widget.close(),o.widget=new d(o,e)}}function u(){n&&(h(n),n=0);var t=o.cm.getCursor(),e=o.cm.getLine(t.line);t.line!=c.line||e.length-t.ch!=l-c.ch||t.ch<c.ch||o.cm.somethingSelected()||t.ch&&s.test(e.charAt(t.ch-1))?o.close():(n=r(a),o.widget&&o.widget.close())}this.cm.on("cursorActivity",u),this.onClose=f},buildOptions:function(t){var e=this.cm.options.hintOptions,i={};for(var n in o)i[n]=o[n];if(e)for(var n in e)void 0!==e[n]&&(i[n]=e[n]);if(t)for(var n in t)void 0!==t[n]&&(i[n]=t[n]);return i}},d.prototype={close:function(){if(this.completion.widget==this){this.completion.widget=null,this.hints.parentNode.removeChild(this.hints),this.completion.cm.removeKeyMap(this.keyMap);var t=this.completion.cm;this.completion.options.closeOnUnfocus&&(t.off("blur",this.onBlur),t.off("focus",this.onFocus)),t.off("scroll",this.onScroll)}},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(t,e){if(t>=this.data.list.length?t=e?this.data.list.length-1:0:t<0&&(t=e?0:this.data.list.length-1),this.selectedHint!=t){var i=this.hints.childNodes[this.selectedHint];i.className=i.className.replace(" "+k,""),(i=this.hints.childNodes[this.selectedHint=t]).className+=" "+k,i.offsetTop<this.hints.scrollTop?this.hints.scrollTop=i.offsetTop-3:i.offsetTop+i.offsetHeight>this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=i.offsetTop+i.offsetHeight-this.hints.clientHeight+3),b.signal(this.data,"select",this.data.list[this.selectedHint],i)}},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}},b.registerHelper("hint","auto",function(t,e){var i,n=t.getHelpers(t.getCursor(),"hint");if(n.length)for(var o=0;o<n.length;o++){var s=n[o](t,e);if(s&&s.list.length)return s}else if(i=t.getHelper(t.getCursor(),"hintWords")){if(i)return b.hint.fromList(t,{words:i})}else if(b.hint.anyword)return b.hint.anyword(t,e)}),b.registerHelper("hint","fromList",function(t,e){for(var i=t.getCursor(),n=t.getTokenAt(i),o=[],s=0;s<e.words.length;s++){var c=e.words[s];c.slice(0,n.string.length)==n.string&&o.push(c)}if(o.length)return{list:o,from:b.Pos(i.line,n.start),to:b.Pos(i.line,n.end)}}),b.commands.autocomplete=b.showHint;var o={hint:b.hint.auto,completeSingle:!0,alignWithWord:!0,closeCharacters:/[\s()\[\]{};:>,]/,closeOnUnfocus:!0,completeOnSingleClick:!1,container:null,customKeys:null,extraKeys:null};b.defineOption("hintOptions",null)});