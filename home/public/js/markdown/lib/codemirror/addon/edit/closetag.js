!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("../fold/xml-fold")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../fold/xml-fold"],e):e(CodeMirror)}(function(v){v.defineOption("autoCloseTags",!1,function(e,t,n){if(n!=v.Init&&n&&e.removeKeyMap("autoCloseTags"),t){var o={name:"autoCloseTags"};("object"!=typeof t||t.whenClosing)&&(o["'/'"]=function(e){return(t=e).getOption("disableInput")?v.Pass:a(t,!0);var t}),("object"!=typeof t||t.whenOpening)&&(o["'>'"]=function(e){return function(e){if(e.getOption("disableInput"))return v.Pass;for(var t=e.listSelections(),n=[],o=0;o<t.length;o++){if(!t[o].empty())return v.Pass;var a=t[o].head,r=e.getTokenAt(a),i=v.innerMode(e.getMode(),r.state),s=i.state;if("xml"!=i.mode.name||!s.tagName)return v.Pass;var l=e.getOption("autoCloseTags"),c="html"==i.mode.configuration,d="object"==typeof l&&l.dontCloseTags||c&&b,f="object"==typeof l&&l.indentTags||c&&y,g=s.tagName;r.end>a.ch&&(g=g.slice(0,g.length-r.end+a.ch));var u=g.toLowerCase();if(!g||"string"==r.type&&(r.end!=a.ch||!/[\"\']/.test(r.string.charAt(r.string.length-1))||1==r.string.length)||"tag"==r.type&&"closeTag"==s.type||r.string.indexOf("/")==r.string.length-1||d&&-1<x(d,u)||P(e,g,a,s,!0))return v.Pass;var m=f&&-1<x(f,u);n[o]={indent:m,text:">"+(m?"\n\n":"")+"</"+g+">",newPos:m?v.Pos(a.line+1,0):v.Pos(a.line,a.ch+1)}}for(var o=t.length-1;0<=o;o--){var h=n[o];e.replaceRange(h.text,t[o].head,t[o].anchor,"+insert");var p=e.listSelections().slice(0);p[o]={head:h.newPos,anchor:h.newPos},e.setSelections(p),h.indent&&(e.indentLine(h.newPos.line,null,!0),e.indentLine(h.newPos.line+1,null,!0))}}(e)}),e.addKeyMap(o)}});var b=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],y=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"];function a(e,t){for(var n=e.listSelections(),o=[],a=t?"/":"</",r=0;r<n.length;r++){if(!n[r].empty())return v.Pass;var i=n[r].head,s=e.getTokenAt(i),l=v.innerMode(e.getMode(),s.state),c=l.state;if(t&&("string"==s.type||"<"!=s.string.charAt(0)||s.start!=i.ch-1))return v.Pass;if("xml"!=l.mode.name)if("htmlmixed"==e.getMode().name&&"javascript"==l.mode.name)o[r]=a+"script>";else{if("htmlmixed"!=e.getMode().name||"css"!=l.mode.name)return v.Pass;o[r]=a+"style>"}else{if(!c.context||!c.context.tagName||P(e,c.context.tagName,i,c))return v.Pass;o[r]=a+c.context.tagName+">"}}e.replaceSelections(o),n=e.listSelections();for(r=0;r<n.length;r++)(r==n.length-1||n[r].head.line<n[r+1].head.line)&&e.indentLine(n[r].head.line)}function x(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0,o=e.length;n<o;++n)if(e[n]==t)return n;return-1}function P(e,t,n,o,a){if(!v.scanForClosingTag)return!1;var r=Math.min(e.lastLine()+1,n.line+500),i=v.scanForClosingTag(e,n,null,r);if(!i||i.tag!=t)return!1;for(var s=o.context,l=a?1:0;s&&s.tagName==t;s=s.prev)++l;n=i.to;for(var c=1;c<l;c++){var d=v.scanForClosingTag(e,n,null,r);if(!d||d.tag!=t)return!1;n=d.to}return!0}v.commands.closeTag=function(e){return a(e)}});