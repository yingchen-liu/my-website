!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)}(function(t){"use strict";function o(){this.posFrom=this.posTo=this.query=null,this.overlay=null}function a(e){return e.state.search||(e.state.search=new o)}function c(e){return"string"==typeof e&&e==e.toLowerCase()}function u(e,o,r){return e.getSearchCursor(o,r,c(o))}function r(e,o,r,n,t){e.openDialog?e.openDialog(o,t,{value:n}):t(prompt(r,n))}function s(e){var o=e.match(/^\/(.*)\/([a-z]*)$/);if(o)try{e=new RegExp(o[1],-1==o[2].indexOf("i")?"":"i")}catch(e){}return("string"==typeof e?""==e:e.test(""))&&(e=/x^/),e}function n(n,t){var i=a(n);if(i.query)return l(n,t);r(n,'Search: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',"Search for:",n.getSelection(),function(o){n.operation(function(){var r,e;o&&!i.query&&(i.query=s(o),n.removeOverlay(i.overlay,c(i.query)),i.overlay=(r=i.query,e=c(i.query),"string"==typeof r?r=new RegExp(r.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),e?"gi":"g"):r.global||(r=new RegExp(r.source,r.ignoreCase?"gi":"g")),{token:function(e){r.lastIndex=e.pos;var o=r.exec(e.string);if(o&&o.index==e.pos)return e.pos+=o[0].length,"searching";o?e.pos=o.index:e.skipToEnd()}}),n.addOverlay(i.overlay),n.showMatchesOnScrollbar&&(i.annotate&&(i.annotate.clear(),i.annotate=null),i.annotate=n.showMatchesOnScrollbar(i.query,c(i.query))),i.posFrom=i.posTo=n.getCursor(),l(n,t))})})}function l(r,n){r.operation(function(){var e=a(r),o=u(r,e.query,n?e.posFrom:e.posTo);(o.find(n)||(o=u(r,e.query,n?t.Pos(r.lastLine()):t.Pos(r.firstLine(),0))).find(n))&&(r.setSelection(o.from(),o.to()),r.scrollIntoView({from:o.from(),to:o.to()}),e.posFrom=o.from(),e.posTo=o.to())})}function i(o){o.operation(function(){var e=a(o);e.query&&(e.query=null,o.removeOverlay(e.overlay),e.annotate&&(e.annotate.clear(),e.annotate=null))})}function f(f,e){f.getOption("readOnly")||r(f,'Replace: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',"Replace:",f.getSelection(),function(l){l&&(l=s(l),r(f,'With: <input type="text" style="width: 10em" class="CodeMirror-search-field"/>',"Replace with:","",function(o){if(e)f.operation(function(){for(var e=u(f,l);e.findNext();)if("string"!=typeof l){var r=f.getRange(e.from(),e.to()).match(l);e.replace(o.replace(/\$(\d)/g,function(e,o){return r[o]}))}else e.replace(o)});else{i(f);var a=u(f,l,f.getCursor()),c=function(){var e,o,r,n,t,i=a.from();!(e=a.findNext())&&(a=u(f,l),!(e=a.findNext())||i&&a.from().line==i.line&&a.from().ch==i.ch)||(f.setSelection(a.from(),a.to()),f.scrollIntoView({from:a.from(),to:a.to()}),r="Replace? <button>Yes</button> <button>No</button> <button>Stop</button>",n="Replace?",t=[function(){s(e)},c],(o=f).openConfirm?o.openConfirm(r,t):confirm(n)&&t[0]())},s=function(r){a.replace("string"==typeof l?o:o.replace(/\$(\d)/g,function(e,o){return r[o]})),c()};c()}}))})}t.commands.find=function(e){i(e),n(e)},t.commands.findNext=n,t.commands.findPrev=function(e){n(e,!0)},t.commands.clearSearch=i,t.commands.replace=f,t.commands.replaceAll=function(e){f(e,!0)}});